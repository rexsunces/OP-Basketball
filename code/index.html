<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link href="css/swiper.css" rel="stylesheet" />
    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="css/style.css?v=2" rel="stylesheet" />
    <script src="js/zepto.min.js"></script>
    <script src="js/touch.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery.easie.js"></script>
    <link href="css/haoest.min.css" rel="stylesheet" />
    <style>
        @-webkit-keyframes myfirst {
            0% {
                width: 15%;
                top: 60%;
            }



            50% {
                width: 20%;
                height: 12%;
                top: 40%;
            }


            100% {
                width: 18%;
                height: 10%;
                top: 20%;
            }
        }

        @keyframes myfirst {
            0% {
                width: 15%;
                top: 60%;
            }

            25% {
                width: 18%;
                top: 50%;
            }

            50% {
                width: 20%;
                top: 40%;
            }

            75% {
                width: 18%;
                top: 30%;
            }

            100% {
                width: 15%;
                top: 20%;
            }
        }

        .myani {
            animation: myfirst 2s;
            -moz-animation: myfirst 2s; /* Firefox */
            -webkit-animation: myfirst 2s; /* Safari 和 Chrome */
            -o-animation: myfirst 2s; /* Opera */
        }

        body {
            padding: 0px;
            margin: 0px;
        }

        .hide {
            display: none;
        }

        .page {
            width: 100%;
            height: 100%;
            position: absolute;
            background-size: 100% 100%;
        }

        .page-index {
            background-image: url('img/back.png');
        }

        .page-rank {
            background-image: url('img/rank-back.png');
        }

            .page-rank .rank-return-btn {
                top: 88%;
                left: 5%;
                width: 30%;
                position: absolute;
            }

            .page-rank .rank-opacity-div {
                position: absolute;
                top: 18%;
                left: 5%;
                width: 90%;
                height: 65%;
                background-color: white;
                opacity: 0.7;
                border-radius: 20px;
            }

            .page-rank .rank-table-div {
                position: absolute;
                top: 20%;
                left: 5%;
                width: 90%;
                min-height: 50%;
            }

            .page-rank table {
                margin-left: auto;
                margin-right: auto;
                margin-top: 20px;
                width: 95%;
                text-align: center;
                font-size: 8px;
            }

                .page-rank table th {
                    height: 20px;
                    border-radius: 5px;
                    border: 2px solid white;
                }

                .page-rank table .th-xuhao {
                    width: 12%;
                    border-radius: 5px;
                    border: 2px solid white;
                }

                .page-rank table .th-normal {
                    width: 22%;
                    border-radius: 5px;
                    border: 2px solid white;
                }

                .page-rank table td {
                    height: 20px;
                    border-radius: 5px;
                    border: 2px solid white;
                }
        .page-0 {
            background-color: #dc292d;
        }

            .page-0 .loading {
                width: 30%;
                height: 40%;
                position: absolute;
                left: 50%;
                top: 40%;
                margin-top: -20%;
                margin-left: -15%;
                font-size: 20%;
                color: #000;
            }

            .page-0 .loading-img {
                width: 100%;
                margin-bottom: 10%;
            }

            .page-0 .loading div {
                position: absolute;
                width: 100%;
                top: 50%;
                text-align: center;
                font-size: 20px;
                font-family: fantasy;
            }
        .page-gaozhi {
            background-image: url('img/gaozhi-back.png');
        }

            .page-gaozhi .gaozhi-enter-btn {
                top: 83%;
                left: 5%;
                width: 40%;
                position: absolute;
            }

            .page-gaozhi .gaozhi-rank-btn {
                top: 83%;
                left: 53%;
                width: 40%;
                position: absolute;
            }
            .page-gaozhi .gaozhi-text {
                position: absolute;
                width: 90%;
                height:55%;
                left: 5%;
                top: 25%;
            }
            .page-gaozhi .enter-pointer {
                position: absolute;
                width: 10%;
                top: 88%;
                left: 40%;
            }
            .page-gaozhi .rank-pointer {
                position: absolute;
                width: 10%;
                top: 88%;
                left: 88%;
            }
        .gai {
            position: absolute;
            width: 35px;
            height: 35px;
            left: 45%;
            top: 90%;
            background-image: url(img/gai.png);
            background-size: 100% 100%;
        }

        .posi {
            position: absolute;
            left: 10%;
            top: 30%;
        }

        .left {
            position: absolute;
            left: 15%;
            top: 80%;
            width: 30%;
        }

        .right {
            position: absolute;
            left: 55%;
            top: 80%;
            width: 30%;
        }

        .ball {
            position: absolute;
            width: 50px;
            height: 50px;
            top: 80%;
            left: 43.5%;
        }

        .basket {
            position: absolute;
            width: 45%;
            height: 30%;
            top: 18%;
            left: 27%;
        }

        .strength {
            position: absolute;
            width: 25px;
            height: 70px;
            left: 85%;
            top: 58%;
        }

        .strength-text {
            position: absolute;
            top: 59%;
            left: 78%;
            width: 15px;
        }

        .strength-arrow {
            position: absolute;
            top: 57%;
            left: 84%;
            width: 40px;
            height: 78px;
        }

        .strength-mask {
            /*background-color: chartreuse;
            position: absolute;
            z-index: 99;
            top: 62%;
            left: 86%;
            height: 43px;
            width: 18px;*/
            background-color: chartreuse;
            position: absolute;
            z-index: 99;
            top: 61%;
            left: 86%;
            height: 45px;
            width: 16px;
            bottom: 0px;
        }

        .rule-btn {
            position: absolute;
            left: 70%;
            width: 28%;
            top: 3%;
        }

        .clock {
            position: absolute;
            left: 5%;
            width: 15%;
            top: 3%;
        }

        .using-time-span {
            position: absolute;
            left: 24%;
            top: 3%;
            font-size: 30px;
            color: #FF9900;
            font-style: italic;
            font-family: fantasy;
            /*font-style: italic;
            color: #FF9900;
            font-family: fantasy;
            text-shadow: 0 0 6px #F96, -1px -1px #FFF, 1px -1px #444;*/
        }

        .rules {
            position: absolute;
            width: 80%;
            left: 10%;
            top: 15%;
            z-index: 998;
        }

        .close-rule-btn {
            position: absolute;
            width: 10%;
            left: 78%;
            top: 16%;
            z-index: 999;
        }
    </style>

</head>
<body onload="PageCtl.loadComplete()">
    <div class="page page-0 page-current">
        <div class="loading">
            <img class="loading-img ani-rotateRight ani-iteration-infinite" src="img/loading.png" />
            <div>Loading</div>
        </div>
    </div>
    <div class="page page-gaozhi hide ">
        <img class="gaozhi-enter-btn" src="img/gaozhi-enter-btn.png" />
        <img class="gaozhi-rank-btn" src="img/gaozhi-rank-btn.png" />
        <img class="gaozhi-text" src="img/gaozhi-text.png" />
        <img class="enter-pointer" src="img/pointer.png" />
        <img class="rank-pointer" src="img/pointer.png" />
    </div>
    <div class="page page-index hide">
        <img class="basket" src="img/basket.png" />
        <img class="clock" src="img/clock.png" />
        <img class="rule-btn" src="img/rule-btn.png" />
        <div class="using-time-span">0.00S</div>
        <div class="rule-div hide">
            <img class="rules" src="img/rules.png" />
            <img class="close-rule-btn" src="img/close-rule-btn.png" />
        </div>

        <div class="gai"></div>
        <span class="posi"></span>
        <span class="combo">Combo</span>
        <span class="score">Score</span>
        <img class="ball " src="img/ball.png" />
        <img class="strength" src="img/strength.png" />
        <img class="strength-arrow" src="img/strength-arrow.png" />
        <img class="strength-text" src="img/strength-text.png" />
        <div class="progress-container" id="prog">
            <div class="progress" style=";background-size:100% 100%;background-repeat:no-repeat;border-top:1px solid black"></div>
            <div class="progress-overlay"></div>
        </div>
    </div>
    <div class="page-rank page hide">
        <div class="rank-opacity-div">

        </div>
        <div class="rank-table-div">
            <table  class="rank-table"></table>
        </div>
        <img class="rank-return-btn" src="img/rank-return-btn.png" />
    </div>
</body>
<script>
    var nowUserId;
    var gameId="basketball_0714";
    var gameStart = false;
    var combo = 0;
    var scoreTotal = 0;
    var mtime = 0;
    var timer;
    var timer_strength;
    var timer_basket;
    var stop_strength = false;
    $j = jQuery.noConflict();
    var i = 0;
    var j = 0;
    var j_direction = 0;
    var direction = 0;
    var screenHeight = document.documentElement.clientHeight || document.body.clientHeight;
    var screenWidth = document.documentElement.clientWidth || document.body.clientWidth;

    var maskHeight = $('#prog .progress').height();
    var basketWidth;
    if ($('.basket').css("width").indexOf('%') > 0) {
        basketWidth = screenWidth * parseInt($('.basket').css("width").substring(0, $('.basket').css("width").indexOf('%'))) / 100;
    }
    else {
        basketWidth = $('.basket').css("width").substring(0, $('.basket').css("width").indexOf('px'));
    }
    

    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }
    //获取当前用户的微信Id
    function GetNowUserId() {
        nowUserId = getUrlParam("openid");
        if (nowUserId != null) {
            window.localStorage.setItem('haizhiyan01', nowUserId);
            window.location = 'index.html?tag=0';
            return false;
        }
        nowUserId = window.localStorage.getItem('haizhiyan01');
        if (nowUserId == null || nowUserId == '') {
            //需要授权获取用户id
            window.location = '/wx/getopenidbyoath2.php?url=' + encodeURIComponent(window.location.pathname + window.location.search);
            return false;
        }
    }
    GetNowUserId();
    var PageCtl = {
        gamePoint: 0,

        currentPageNumber: 0,

        effects: { moveUp: 1, moveDown: 2, fade: 3 },

        directions: { up: 1, down: -1 },

        isAnimating: false,

        pageMove: function (effect, pageNumber) {
            if (!PageCtl.isAnimating) {
                PageCtl.isAnimating = true;
                var fromPage = ".page-" + PageCtl.currentPageNumber;
                var toPage = ".page-" + pageNumber;
                PageCtl.currentPageNumber = pageNumber;

                switch (effect) {
                    case PageCtl.effects.fade:
                        outClass = 'ani-fadeOut';
                        inClass = 'ani-fadeIn';
                        break;
                }

                $(toPage).removeClass("hide");
                $(fromPage).addClass(outClass);
                $(toPage).addClass(inClass);

                setTimeout(function () {
                    $(fromPage).removeClass('page-current');
                    $(fromPage).removeClass(outClass);
                    $(fromPage).addClass("hide");
                    //$(fromPage).find("*").addClass("hide");

                    $(toPage).addClass('page-current');
                    $(toPage).removeClass(inClass);
                    //$(toPage).find("*").removeClass("hide");

                    PageCtl.isAnimating = false;
                }, 600);
            }
        },


        loadComplete: function () {
            PageCtl.pageMove(PageCtl.effects.fade, "gaozhi");
            GetNowUserInfo();
        }
    };

    function GameReset() {
        gameStart = false;
        combo = 0;
        scoreTotal = 0;
        mtime = 0;
        stop_strength = false;
        i = 0;
        j = 0;
        j_direction = 0;
        direction = 0;
        PageCtl.pageMove(PageCtl.effects.fade, "gaozhi");
    }
    function GameEnd() {
        clearInterval(timer_basket);
        clearInterval(timer_strength);
        $.get("/index.php?r=game/play", {
            "userId":nowUserId ,
            "gameId": gameId,
            "timeUsed": mtime
        }, function (data, textStatus) {
            if (data.success = true) {
                //更新成功
                alert("恭喜完成疯狂投篮任务，快快邀请好友一起挑战吧！");
                GameReset();
            }
            else {
                alert("上传成绩失败！");
                GameReset();

            }
        })
    }
    function GameTimerStart() {
        timer_strength = setInterval(function () {
            if (stop_strength == true) {

            }
            else {
                if (j_direction == 0) {
                    j++;

                    if (j == 100) {
                        j_direction = 1;

                    }
                }
                else {
                    j--;
                    if (j == 0) {
                        j_direction = 0;

                    }
                }
                $('#prog .progress').css('height', j + '%');
            }
        }, 10);

        timer_basket = setInterval(function () {
            if (direction == 0) {

                $('.basket').css('left', (i++) + 'px');
                //alert("测试：" + screenWidth+","+basketWidth);
                if (i + parseInt( basketWidth) > screenWidth) {
                    direction = 1;
                }
            }
            else {
                $('.basket').css('left', (i--) + 'px');
                if (i < 0) {
                    direction = 0;
                }
            }
            mtime += 20;
            $('.using-time-span').text((mtime / 1000).toFixed(2) + "S");
        }, 20);
    }
    $(function () {
        // GameTimerStart();
        $('.combo').text("Combo : x" + combo)
        $('.score').text("Score : " + scoreTotal)
        $('.rule-btn').on('singleTap', function () {
            if ($('.rule-div').hasClass("hide")) {
                $('.rule-div').removeClass("hide");
            }
        })
        $('.close-rule-btn').on('singleTap', function () {
            $('.rule-div').addClass("hide");
        })
        $('.gai').on('touchstart pointerdown', function () {
            if (gameStart == false) {
                gameStart = true;
                GameTimerStart();
                $('.ball').addClass("ani-rotateRight ani-iteration-infinite");
            }
            else {
                //$j('.ball').addClass("myani");
                // $j('.ball').animate({ top: '30%' }, 2000);
                if (!$j('.ball').is(":animated")) {
                    stop_strength = true;
                    var lidu = (j / 100).toFixed(2);

                    $j('.ball').animate({ top: (80 - 80 * lidu) + '%', width: '60px', height: '60px' }, 2000, "easieEaseOutCubic", function () {
                        var ballTop;
                        var ballLeft;
                        var basketTop;
                        var basketLeft;
                        if ($('.ball').css("top").indexOf('%') > 0) {
                            ballTop = screenHeight * parseInt($('.ball').css("top").substring(0, $('.ball').css("top").indexOf('%'))) / 100;
                        }
                        else {
                            ballTop = parseInt($('.ball').css("top").substring(0, $('.ball').css("top").indexOf('px')));
                        }
                        if ($('.ball').css("left").indexOf('%') > 0) {
                            ballLeft = screenWidth * parseInt($('.ball').css("left").substring(0, $('.ball').css("left").indexOf('%'))) / 100;
                        }
                        else {
                            ballLeft = parseInt($('.ball').css("left").substring(0, $('.ball').css("left").indexOf('px')));
                        }

                        if ($('.basket').css("top").indexOf('%') > 0) {
                            basketTop = screenHeight * parseInt($('.basket').css("top").substring(0, $('.basket').css("top").indexOf('%'))) / 100;
                        }
                        else {
                            basketTop = parseInt($('.basket').css("top").substring(0, $('.basket').css("top").indexOf('px')));
                        }

                        if ($('.basket').css("left").indexOf('%') > 0) {
                            basketLeft = screenHeight * parseInt($('.basket').css("left").substring(0, $('.basket').css("left").indexOf('%'))) / 100;
                        }
                        else {
                            basketLeft = parseInt($('.basket').css("left").substring(0, $('.basket').css("left").indexOf('px')));
                        }

                        //ballTop = screenHeight * parseInt($('.ball').css("top").substring(0, $('.ball').css("top").indexOf('%'))) / 100;
                        //ballLeft = parseInt($('.ball').css("left").substring(0, $('.ball').css("left").indexOf('px')));
                        //basketTop = parseInt($('.basket').css("top").substring(0, $('.basket').css("top").indexOf('px')));
                        //basketLeft = parseInt($('.basket').css("left").substring(0, $('.basket').css("left").indexOf('px')));
                        var basketWidth = $('.basket').width();
                        var basketHeight = $('.basket').height();
                        var ballWidth = $('.ball').width();
                        var ballHeight = $('.ball').height();
                        var ballPoint = { left: (ballLeft + ballWidth / 2), top: (ballTop + ballHeight / 2) };
                        // alert(ballTop + "," + ballLeft + "," + basketTop + "," + basketLeft);
                        var basketPoint = { left: (basketLeft + basketWidth / 2), top: (basketTop + basketHeight / 2) };

                        // alert("球宽度：" + ballWidth + ",球中心点与篮筐中心点宽度相差：" + (ballPoint.left - basketPoint.left) + "||球高度：" + ballHeight + ",球中心点与篮筐中心点高度相差：" + (ballPoint.top - basketPoint.top));
                        if (Math.abs(ballPoint.left - basketPoint.left) < (ballWidth) && (basketPoint.top - ballPoint.top) > 0 && (basketPoint.top - ballPoint.top) < 50) {
                            $('.combo').text("Combo : x" + (++combo)).addClass("combo-hover");
                            // $('.posi').text("进球了！Max combo: " + (++combo));
                            scoreTotal++;
                            $('.score').text("Score : " + scoreTotal);
                            if (scoreTotal == 10) {
                                GameEnd();
                            }
                        }
                        else {
                            combo = 0;
                            $('.combo').text("Combo : x" + combo).removeClass("combo-hover");
                        }
                        $j('.ball').css('width', '50px').css('height', '50px').css('top', '80%');
                        stop_strength = false;
                    })
                }
            }
        })

        $('.gaozhi-enter-btn').on('singleTap', function () {
            PageCtl.pageMove(PageCtl.effects.fade, "index");
        })
        $('.gaozhi-rank-btn').on('singleTap', function () {
            $('.rank-table').html("");
            $.get("/index.php?r=game/getrankbytime", {
				"gameId": gameId
            }, function (data, textStatus) {
                if (data.success = true) {
                    //获取成功
                    var rankstr = "<tr><th class='th-xuhao'>序号</th><th class='th-normal'>昵称</th><th class='th-normal'>投射时间</th><tr>";
                    for (var i = 0; i < data.data.length; i++) {
                        rankstr += "<tr>" +
                            "<td class='th-align-center'>" + parseInt(i + 1) +
                            "</td><td class='th-align-center'>" + (data.data[i].user_name == null ? data.data[i].user_id : data.data[i].user_name) +
                            "</td><td class='th-align-center'>" + (data.data[i].time_used == null ? "-" : (data.data[i].time_used/ 1000).toFixed(2)) + " S" +
                            "</td>" +
                            "</tr>";
                    }
                    $('.rank-table').append(rankstr);
                    PageCtl.pageMove(PageCtl.effects.fade, "rank");
                }
                else {
                    alert("数据获取失败！");
                }
            })    
        })
        $('.rank-return-btn').on('singleTap', function () {
            PageCtl.pageMove(PageCtl.effects.fade, "gaozhi");
        })
        function GoalOk() {

        }
    })
</script>

</html>
